# LottoGoGo 확률 엔진 PRD (v1 – 추천안)

## 1. 개요
- **제품명:** LottoGoGo Probability Engine
- **목적:**  
  CSV 기반 과거 로또 회차 데이터를 입력으로 받아, 통계·확률 기반 점수화 + 필터링 + 시뮬레이션을 통해 **3개 이상 적중 확률을 최대화하는 추천 조합 생성 엔진**을 구축한다.
- **범위:**  
  UI / 웹 / API는 제외하고 **순수 로직 엔진**에만 집중한다.

---

## 2. 목표

### 2.1 최적화 목표 (Primary Objective)
- **P(match ≥ 3) 최대화**
  - 백테스팅 기준으로 3개 이상 적중 확률을 가장 중요한 KPI로 삼는다.

### 2.2 보조 목표
- 평균 적중 개수 유지 또는 소폭 개선
- 결과 분산 최소화(안정성)
- 동일 입력 + 동일 파라미터 + 동일 seed → 동일 결과(재현성)

---

## 3. 입력 / 출력

### 입력
- CSV 파일
  - 컬럼: `round, n1, n2, n3, n4, n5, n6`
  - 번호 범위: 1~45
- Config 파일(yaml/json)
  - 모든 기간, 가중치, penalty, seed 포함

### 출력
- 추천 조합 K개 (기본 5개)
- 각 조합별 메타 정보
  - 조합 점수
  - 번호별 점수 breakdown
  - 필터 통과 정보

---

## 4. 전체 파이프라인

1. CSV 데이터 로딩 및 검증
2. Feature 계산
3. 번호별 점수 계산
4. 몬테카를로 샘플링으로 후보 조합 생성
5. 필터 파이프라인 적용
6. 조합 랭킹 및 다양성 제약
7. (옵션) 백테스터로 성능 평가

---

## 5. 번호별 점수 계산 로직 (핵심)

각 번호 i(1~45)에 대해:

```
raw_score(i) = BaseScore(i) + Boost(i) - Penalty(i)
```
정규화 후 샘플링 확률로 변환한다.

---

### 5.1 BaseScore – 베이지안 레이어

- **모델:** Beta Distribution
- **기간:** 최근 N회 (기본 50회)
- **정의:**
  - success_i = 최근 N회에서 번호 i가 등장한 회차 수
  - trial = N
- **Prior:** Beta(1,1)
- **Posterior Mean:**
  ```
  bayes_score(i) = (success_i + α) / (trial + α + β)
  ```

---

### 5.2 Boost – 휴리스틱 가중치 레이어

| 항목 | 조건 | 기본 가중치 |
|----|----|----|
| Hot | 최근 5회 중 ≥2회 등장 | +0.4 |
| Cold | 최근 10회 중 0회 | +0.15 |
| Neighbor | 직전 회차 번호 ±1 | +0.3 |
| Carryover | 직전 회차 번호 | +0.2 |
| Reverse | 역수 관계 | +0.1 |

- 각 Boost는 독립적으로 계산
- 충족 조건은 로그로 기록

---

### 5.3 Penalty – 제외수 분석 레이어

#### Poisson Penalty
- 최근 W회 기준 기대 등장 횟수 대비 과출현 번호에 penalty 부여

#### Markov Penalty
- 직전 회차 → 다음 회차 번호 전이 빈도 기반
- 과도하게 반복되는 전이에 penalty

#### Ensemble
```
Penalty(i) = λ1 * poisson_penalty(i) + λ2 * markov_penalty(i)
```

- penalty는 **확률 감소용**
- 절대 0 확률 금지 (floor 적용)

---

### 5.4 확률 변환

- 모든 raw_score에 대해
```
p(i) = Softmax(raw_score(i))
p(i) = max(p(i), MIN_PROB_FLOOR)
```
- 이후 재정규화

---

## 6. 조합 생성 (Monte Carlo)

- 번호 확률 p(i)를 이용해 **중복 없이 6개 샘플링**
- 샘플 수 M (기본 50,000~100,000)
- 목적:
  - 필터 통과 후 충분한 후보 확보
  - 분산 감소

---

## 7. 필터 파이프라인 (필수)

| 필터 | 조건 |
|----|----|
| 합계 | 100 ~ 175 |
| AC 값 | ≥ 7 |
| 구간 분산 | 구간당 최대 3개 |
| 끝수 | 동일 끝수 ≤ 2 |
| 홀짝 | 2:4 ~ 4:2 |
| 고저 | 균형 유지 |
| 과거 당첨 | 5개 이상 일치 시 폐기 |

- 각 필터는 탈락 사유 코드 반환

---

## 8. 조합 랭킹 & 다양성

- 기본 점수:
```
combo_score = Σ raw_score(i)
```
- 상위 K개 선택
- 다양성 제약:
  - 조합 간 교집합 ≥4개인 경우 하나 제거

---

## 9. 백테스터 설계

### 방식
- 워크포워드 테스트
  - t회차까지 학습 → t+1 평가
  - 전체 구간 반복

### 기준선
- 완전 랜덤 번호 생성기

### 지표
- **Primary:** P(match ≥ 3)
- Secondary:
  - 평균 적중 개수
  - P(match ≥ 4)
  - 표준편차

---

## 10. 튜닝 원칙

- 모든 수치는 Config로 관리
- Train / Validation / Holdout 분리
- Holdout 성능 미달 시 파라미터 폐기
- Seed 고정 필수

---

## 11. 비고

- 본 엔진은 통계적 참고 도구이며, 당첨을 보장하지 않는다.
- API / Web UI는 엔진 완성 이후 단계에서 별도 설계한다.
