# LottoGoGo Probability Engine - 기술 설계 문서 (TRD)

## 1. 목표 / 범위

### 1.1 목표
- **Primary:** 3개 이상 적중 확률 P(match ≥ 3) 최대화
- **Secondary:** 평균 적중 개수 유지, 결과 분산 최소화, 재현성 보장 (동일 seed → 동일 결과)

### 1.2 범위

#### In Scope (포함)
- CSV 기반 과거 로또 데이터 로딩 및 검증
- 번호별 통계/확률 기반 점수 계산 (베이지안 + 휴리스틱)
- 몬테카를로 샘플링 기반 조합 생성
- 필터 파이프라인 (합계, AC값, 구간분산, 끝수, 홀짝, 고저, 과거당첨)
- 조합 랭킹 및 다양성 제약 적용
- 백테스터를 통한 성능 평가
- Config 기반 파라미터 관리

#### Out of Scope (제외)
- Web UI / API 서버
- 사용자 인증/인가
- 데이터베이스 영구 저장 (엔진은 파일 기반으로만 동작)
- 외부 API 연동

---

## 2. 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        LottoGoGo Probability Engine                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────────────────┐  │
│  │  Input Layer  │    │ Config Layer │    │    Output Layer          │  │
│  │  (CSV Data)   │    │ (YAML/JSON)  │    │    (Recommendations)     │  │
│  └──────┬───────┘    └──────┬───────┘    └────────────▲─────────────┘  │
│         │                   │                         │                  │
│         ▼                   ▼                         │                  │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                        Core Engine                                │  │
│  ├──────────────────────────────────────────────────────────────────┤  │
│  │                                                                    │  │
│  │  ┌─────────────┐   ┌─────────────┐   ┌─────────────────────────┐  │  │
│  │  │ Data Loader │──▶│  Feature    │──▶│    Score Calculator     │  │  │
│  │  │  & Validator│   │  Extractor  │   │ (Bayes + Boost - Penalty)│  │  │
│  │  └─────────────┘   └─────────────┘   └───────────┬─────────────┘  │  │
│  │                                                   │                │  │
│  │                                                   ▼                │  │
│  │  ┌─────────────┐   ┌─────────────┐   ┌─────────────────────────┐  │  │
│  │  │  Backtester │◀──│   Ranker    │◀──│  Monte Carlo Sampler    │  │  │
│  │  │             │   │ + Diversity │   │  + Filter Pipeline      │  │  │
│  │  └─────────────┘   └─────────────┘   └─────────────────────────┘  │  │
│  │                                                                    │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 주요 모듈 책임

| 모듈 | 책임 | 주요 기능 |
|------|------|-----------|
| `data_loader` | 데이터 입출력 | CSV 파싱, 검증, Config 로딩 |
| `feature_extractor` | 통계 분석 | 빈도 계산, Hot/Cold 분석, Neighbor/Carryover 분석 |
| `score_calculator` | 점수 계산 | 베이지안 점수, Boost/Penalty 계산, Softmax 정규화 |
| `sampler` | 조합 생성 | 몬테카를로 샘플링, 필터 파이프라인 적용 |
| `filters` | 조합 필터링 | 합계, AC값, 구간분산, 끝수, 홀짝, 고저, 과거당첨 필터 |
| `ranker` | 랭킹/다양성 | 조합 점수 계산, 다양성 제약 적용 |
| `backtester` | 성능 평가 | Walk-forward 테스트, 지표 계산 |
| `config` | 설정 관리 | 파라미터 로딩, 기본값 적용, 검증 |

---

## 4. 데이터 흐름

```
CSV 파일 ─────────────────────────────────────────────────────────────────▶

[1. 로딩/검증]
    ├── history.csv 로딩
    ├── 컬럼 검증 (round, n1~n6)
    └── 범위 검증 (1~45)
         │
         ▼
[2. Feature 계산]
    ├── 최근 N회 빈도 집계
    ├── Hot/Cold 플래그 계산
    ├── Neighbor/Carryover 계산
    └── Markov 전이 행렬 계산
         │
         ▼
[3. 점수 계산]
    ├── BaseScore: Beta Posterior Mean
    ├── Boost: Hot/Cold/Neighbor/Carryover/Reverse
    ├── Penalty: Poisson + Markov
    └── Softmax → 샘플링 확률 p(i)
         │
         ▼
[4. 조합 생성]
    ├── Monte Carlo: M개 후보 생성 (50,000~100,000)
    └── 중복 없이 6개씩 샘플링
         │
         ▼
[5. 필터링]
    ├── 합계 필터 (100~175)
    ├── AC값 필터 (≥7)
    ├── 구간분산 필터 (구간당 ≤3)
    ├── 끝수 필터 (동일 끝수 ≤2)
    ├── 홀짝 필터 (2:4~4:2)
    ├── 고저 필터 (균형)
    └── 과거당첨 필터 (5개 이상 일치 시 폐기)
         │
         ▼
[6. 랭킹 & 다양성]
    ├── 조합 점수 = Σ raw_score(i)
    ├── 상위 K개 선택
    └── 교집합 ≥4 조합 제거
         │
         ▼
─────────────────────────────────────────────────────────▶ 추천 조합 출력
```

---

## 5. 기술 스택 기본값

| 영역 | 기술 | 비고 |
|------|------|------|
| **언어** | Python 3.11+ | 타입 힌트 적극 활용 |
| **패키지/실행** | uv | 빠른 의존성 관리 |
| **수치 연산** | NumPy, SciPy | 베이지안/확률 계산 |
| **데이터 처리** | Pandas | CSV 로딩, 집계 |
| **Config** | YAML (PyYAML) | 파라미터 관리 |
| **테스트** | pytest + pytest-asyncio | 단위/통합 테스트 |
| **타입 체크** | mypy | 정적 타입 검사 |
| **로깅** | Python logging | 표준 라이브러리 |

> **Note:** PRD에서 API/DB 없이 순수 로직 엔진으로 명시하였으므로, FastAPI/PostgreSQL/SQLAlchemy/Alembic/JWT는 제외합니다.

---

## 6. 외부 의존성

| 패키지 | 버전 | 용도 |
|--------|------|------|
| `numpy` | ^2.0 | 수치 연산, 확률 계산 |
| `scipy` | ^1.14 | Beta 분포, 통계 함수 |
| `pandas` | ^2.2 | CSV 파싱, 데이터 처리 |
| `pyyaml` | ^6.0 | Config 파일 파싱 |
| `pydantic` | ^2.0 | Config/Output 스키마 검증 |

### Dev Dependencies
| 패키지 | 용도 |
|--------|------|
| `pytest` | 테스트 프레임워크 |
| `pytest-cov` | 커버리지 측정 |
| `mypy` | 타입 체크 |
| `ruff` | 린팅/포매팅 |

---

## 7. 비기능 요구사항

| 항목 | 요구사항 | 측정 방법 |
|------|----------|-----------|
| **재현성** | 동일 seed → 동일 결과 100% | 테스트 케이스 검증 |
| **성능** | 100,000 샘플 생성 < 5초 | 벤치마크 테스트 |
| **안정성** | 모든 입력에 대해 최소 K개 결과 반환 | 엣지 케이스 테스트 |
| **확장성** | 새 필터/Boost 추가 시 기존 코드 수정 최소화 | 플러그인 패턴 적용 |
| **가독성** | 모든 public 함수에 docstring | CI 검사 |
| **테스트** | 커버리지 80% 이상 | pytest-cov |

---

## 8. Assumptions / Open Questions

### Assumptions (가정)
1. CSV 파일은 UTF-8 인코딩으로 제공된다.
2. 과거 데이터는 최소 100회차 이상 존재한다.
3. 번호 범위는 한국 로또 기준 1~45로 고정한다.
4. Config 파일이 없을 경우 기본값을 사용한다.
5. 엔진은 단일 프로세스에서 실행된다 (병렬 처리 불필요).

### Open Questions (미결 사항)
1. **Boost 가중치 튜닝:** 초기 가중치(Hot: 0.4, Cold: 0.15 등)는 백테스팅 후 조정 가능한가?
2. **필터 우선순위:** 필터 적용 순서가 성능에 영향을 미치는가? (현재는 순차 적용 가정)
3. **Penalty λ 값:** Poisson/Markov penalty의 λ1, λ2 기본값 결정 필요.
4. **다양성 임계값:** 교집합 ≥4 기준은 조정 가능해야 하는가?
5. **메모리 제약:** 대규모 샘플(100,000+) 시 메모리 최적화 필요 여부.
